---
- name: Check if NFS backup directory exists on node
  stat:
    path: '{{db_backup_nfs_path}}'
  register: nfs_dir_mounted
  when: not test

- name: Fail if NFS share is not mounted on node for db backup
  fail:
    msg: "NFS share is not mounted on node for db backup."
  when: not test && not nfs_dir_mounted

- name: Ensure local dir exists on node for db volume sharing
  file:
    path: '{{ db_local_volume }}'
    state: directory
    mode: 0766
  sudo: yes
  tags: db

- name: Set ACL for local dir for volumen sharing
  acl:
    path: '{{ db_local_volume }}'
    default: yes
    entity: '{{ postgresql_uid }}'
    etype: user
    follow: no
    permissions: wx
    recursive: yes
    state: present
  sudo: yes
  tags: db

- name: Reload docker systemd service
  sudo: yes
  systemd: name=docker state=reloaded

- name: Start Docker service
  sudo: yes
  systemd: name=docker state=started enabled=yes

- name: Pull CentOS postgres container
  docker_image:
      name: registry.centos.org/sclo/postgresql-95-centos7
      tag: latest
  sudo: yes
  tags: db

- name: Run postgres container
  docker_container:
      name: postgres
      image: '{{ postgresql_image }}'
      volumes:
        - "{{ db_local_volume }}:/var/lib/pgsql/data:Z"
      ports:
        - "{{ db_host }}:{{ db_port }}:5432"
      env:
          POSTGRESQL_USER: '{{ db_user }}'
          POSTGRESQL_PASSWORD: '{{ db_pass }}'
          POSTGRESQL_DATABASE: '{{ db_name }}'
      state: started
      restart_policy: on-failure
  sudo: yes
  tags: db

- name: Wait for 20 seconds for the db to come up
  pause:
      seconds: 20
  tags: db

- name: Copy cron script to have postgresql db backups
  sudo: yes
  template: src=cccp_db_pg_dump_cron.sh.j2 dest=/root/cccp_db_pg_dump_cron.sh mode=0755
  tags:
    - db
    - cron

- name: Cron job for postgresql db backups hourly
  sudo: yes
  cron:
      name: "Postgresql cccp db hourly backup"
      job: "/root/cccp_db_pg_dump_cron.sh"
      special_time: hourly
  tags:
    - db
    - cron
